WITH JT AS(
    SELECT 
        ID,COUNTRY,RC.CITY,ADDRESS,COMPANY,RC.OFFICE_SIZE,CONTRACT_START,CONTRACT_END,CONTRACT_LENGTH,MONTHS_UNTIL_EXPIRY,PEOPLE,PER_PERSON,RENT_PER_MONTH
    FROM(
            SELECT 
                *,
                datediff('MONTH', TO_DATE(CONTRACT_START,'DD/MM/YYYY'),TO_DATE(CONTRACT_END,'DD/MM/YYYY')) AS "CONTRACT_LENGTH",
                datediff('MONTH', TO_DATE(CONTRACT_START,'DD/MM/YYYY'),'2022-04-22'::DATE) AS "MONTHS_UNTIL_EXPIRY"                 
                                                                //Snowflake feature '::' casts strings
            FROM
                RA_PD_2022_WK15_RC) AS RC
            INNER JOIN
                (
                    SELECT 
                        *
                    FROM
                        RA_PD_2022_WK15_OSP
                ) AS OSP
    ON (RC."CITY" = OSP."CITY" AND RC."OFFICE_SIZE" = OSP."OFFICE_SIZE")
),


GR (ID,COUNTRY,CITY,ADDRESS,COMPANY,OFFICE_SIZE,CONTRACT_START,CONTRACT_END,CONTRACT_LENGTH,MONTHS_UNTIL_EXPIRY,PEOPLE,PER_PERSON,RENT_PER_MONTH,MONTH_DIVIDER_N)
AS                  //Recursive CTE
    (
    SELECT          //ANCHOR
        ID,COUNTRY,CITY,ADDRESS,COMPANY,OFFICE_SIZE,CONTRACT_START,CONTRACT_END,CONTRACT_LENGTH,MONTHS_UNTIL_EXPIRY,PEOPLE,PER_PERSON,RENT_PER_MONTH,
        1   
    FROM JT
    UNION ALL
        SELECT      //RECURSIVE STATEMENT
            ID,COUNTRY,CITY,ADDRESS,COMPANY,OFFICE_SIZE,CONTRACT_START,CONTRACT_END,CONTRACT_LENGTH,MONTHS_UNTIL_EXPIRY,PEOPLE,PER_PERSON,RENT_PER_MONTH,
            MONTH_DIVIDER_N + 1
        FROM GR
        WHERE MONTH_DIVIDER_N < MONTHS_UNTIL_EXPIRY
    )
    
SELECT
    SUM(CAST(RENT_PER_MONTH AS INT)) OVER(  PARTITION BY ID
                                            ORDER BY MONTH_DIVIDER_N) AS "CUMULATIVE_MONTHLY", //Running total per ID, Ordered by Month Divider (each month)
    *,
    DATEADD('MONTH',MONTH_DIVIDER_N,date_trunc('MONTH', TO_DATE(CONTRACT_START,'DD/MM/YYYY'))) AS "MONTH_DIVIDER"
    FROM GR
    ORDER BY ID, "MONTH_DIVIDER" ;